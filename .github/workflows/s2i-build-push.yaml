# This example workflow will build container image
# of the application using source to image build
# startegy and push the image to quay.io (Image registry)

name: Build and Push
on: [push, workflow_dispatch, pull_request]
env:
  IMAGE_REGISTRY: quay.io
  REGISTRY_USER: tetchell
  APP_NAME: petclinic
  IMAGE_TAG: latest

jobs:
  test-s2i-job:
    runs-on: ubuntu-latest
    name: A job to build and push image
    steps:
      # Setup Docker Deamon as Docker Daemon should be
      # running to successfully build image using s2i
      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v1
        with:
          version: latest

      # Checkout spring petclinic repository
      - name: Checkout
        uses: actions/checkout@v2

      # Setup S2i and Build container image
      - name: Setup and Build
        uses: redhat-actions/s2i-build@main
        with:
          path_context: '.'
          tag: ${{ env.IMAGE_TAG }}
          builder_image: 'registry.access.redhat.com/openjdk/openjdk-11-rhel7'
          image_name: ${{ env.APP_NAME }}
          
      # Push Image to Quay registry
      - name: Push To Quay Action
        uses: redhat-actions/push-to-registry@main
        with:
          image: ${{ env.APP_NAME }}
          tag: ${{ env.IMAGE_TAG }}
          registry: ${{ env.IMAGE_REGISTRY }}/${{ env.REGISTRY_USER }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

